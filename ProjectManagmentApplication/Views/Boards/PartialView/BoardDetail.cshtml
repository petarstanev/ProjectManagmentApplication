@using ProjectManagementApplication.Models
@model Board


@foreach (var column in Model.Columns)
{
    <div class="col-md-2">
        <div class="board-column btn-primary">
            <h4 class="text-center column-header">
                @Html.ActionLink(column.Title, "Edit", "Columns", new { id = column.ColumnId }, null)
            </h4>
            <div id="column_@column.ColumnId" class="board-column-tasks">
                @foreach (Task task in column.Tasks)
                {
                    <a href="@Url.Action("Details", "Tasks", new {id = task.TaskId})">
                        <div id="task_@task.TaskId" class="task-container btn-info">
                            <div class="task-header">
                                <div class="task-header">@task.Title</div>
                            </div>
                        </div>
                    </a>


                }
            </div>
        </div>
    </div>
}


<script type="text/javascript">
    $(document).ready(function () {
        var hub = $.connection.boardHub;
        $.connection.hub.start().done(function () {
            $(".board-column-tasks")
                .sortable({
                    connectWith: ".board-column-tasks",
                    cancel: ".add-column-btn",
                    start: function (event, ui) {
                        ui.item.addClass('task-moving');
                    },
                    stop: function (event, ui) {
                        ui.item.removeClass("task-moving");
                    },
                    receive: function (event, ui) {
                        var taskId = ui.item[0].id.replace(/^\D+/g, '');//get id number from id
                        var columnId = this.id.replace(/^\D+/g, '');
                        if (columnId > 0 && taskId > 0) {
                            $.ajax({
                                url: '/Tasks/ChangeTaskColumn',
                                type: "POST",
                                data: { taskId: taskId, columnId: columnId },
                                statusCode: {
                                    400: function (data) {
                                        console.log('Opps an error occurred.');
                                    },
                                    200: function (data) {
                                        var boardId = $("#board-id").val();

                                        hub.server.boardUpdated(boardId);
                                    }
                                }
                            });
                        } else {
                            console.log(columnId + " " + taskId + " " + this.id);
                        }
                    }
                });
        });

        $(".modal").on('show.bs.modal', function () {
            $(".board-column-tasks").sortable("disable");
        });

        $(".modal").on('hide.bs.modal', function () {
            $(".board-column-tasks").sortable("enable");
        });
    });
</script>